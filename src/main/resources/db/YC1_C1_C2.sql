-- Đảm bảo đang ở ATBM_PDB
ALTER SESSION SET CONTAINER = ATBMCQ_16_CSDL;

-- Tạo bảng DONVI
CREATE TABLE DONVI (
    MADV VARCHAR2(10),
    TENDV VARCHAR2(50) NOT NULL,
    LOAIDV VARCHAR2(10) CHECK (LOAIDV IN ('Khoa', 'Phòng')),
    TRGDV VARCHAR2(10),
    CONSTRAINT PK_DONVI PRIMARY KEY (MADV)
);

-- Tạo bảng NHANVIEN
CREATE TABLE NHANVIEN (
    MANV VARCHAR2(10),
    HOTEN VARCHAR2(50) NOT NULL,
    PHAI VARCHAR2(3) CHECK (PHAI IN ('Nam', 'Nu')),
    NGSINH DATE NOT NULL,
    LUONG NUMBER(10,2) CHECK (LUONG >= 0),
    PHUCAP NUMBER(10,2) CHECK (PHUCAP >= 0),
    DT VARCHAR2(15),
    VAITRO VARCHAR2(10) CHECK (VAITRO IN ('NVCB', 'GV', 'NV PĐT', 'NV PKT', 'NV TCHC', 'NV CTSV', 'TRGDV')) NOT NULL,
    MADV VARCHAR2(10),
    CONSTRAINT PK_NHANVIEN PRIMARY KEY (MANV),
    CONSTRAINT FK_NHANVIEN_DONVI FOREIGN KEY (MADV) REFERENCES DONVI(MADV)
);

-- Thêm ràng buộc khóa ngoại cho TRGDV sau khi tạo NHANVIEN
ALTER TABLE DONVI
ADD CONSTRAINT FK_DONVI_NHANVIEN FOREIGN KEY (TRGDV) REFERENCES NHANVIEN(MANV);

-- Tạo bảng SINHVIEN
CREATE TABLE SINHVIEN (
    MASV VARCHAR2(10),
    HOTEN VARCHAR2(50) NOT NULL,
    PHAI VARCHAR2(3) CHECK (PHAI IN ('Nam', 'Nu')),
    NGSINH DATE NOT NULL,
    DCHI VARCHAR2(100),
    DT VARCHAR2(15),
    KHOA VARCHAR2(10),
    TINHTRANG VARCHAR2(20) CHECK (TINHTRANG IN ('Đang học', 'Nghỉ học', 'Bảo lưu')),
    CONSTRAINT PK_SINHVIEN PRIMARY KEY (MASV),
    CONSTRAINT FK_SINHVIEN_DONVI FOREIGN KEY (KHOA) REFERENCES DONVI(MADV)
);

-- Tạo bảng HOCPHAN
CREATE TABLE HOCPHAN (
    MAHP VARCHAR2(10),
    TENHP VARCHAR2(50) NOT NULL,
    SOTC NUMBER CHECK (SOTC > 0),
    STLT NUMBER CHECK (STLT >= 0),
    STTH NUMBER CHECK (STTH >= 0),
    MADV VARCHAR2(10),
    CONSTRAINT PK_HOCPHAN PRIMARY KEY (MAHP),
    CONSTRAINT FK_HOCPHAN_DONVI FOREIGN KEY (MADV) REFERENCES DONVI(MADV)
);

-- Tạo bảng MOMON
CREATE TABLE MOMON (
    MAMM VARCHAR2(10),
    MAHP VARCHAR2(10),
    MAGV VARCHAR2(10),
    HK NUMBER CHECK (HK IN (1, 2, 3)),
    NAM NUMBER,
    CONSTRAINT PK_MOMON PRIMARY KEY (MAMM),
    CONSTRAINT FK_MOMON_HOCPHAN FOREIGN KEY (MAHP) REFERENCES HOCPHAN(MAHP),
    CONSTRAINT FK_MOMON_NHANVIEN FOREIGN KEY (MAGV) REFERENCES NHANVIEN(MANV)
);


-- Tạo bảng DANGKY
CREATE TABLE DANGKY (
    MASV VARCHAR2(10),
    MAMM VARCHAR2(10),
    DIEMTH NUMBER CHECK (DIEMTH >= 0 AND DIEMTH <= 10),
    DIEMQT NUMBER CHECK (DIEMQT >= 0 AND DIEMQT <= 10),
    DIEMCK NUMBER CHECK (DIEMCK >= 0 AND DIEMCK <= 10),
    DIEMTK NUMBER CHECK (DIEMTK >= 0 AND DIEMTK <= 10),
    CONSTRAINT PK_DANGKY PRIMARY KEY (MASV, MAMM),
    CONSTRAINT FK_DANGKY_SINHVIEN FOREIGN KEY (MASV) REFERENCES SINHVIEN(MASV),
    CONSTRAINT FK_DANGKY_MOMON FOREIGN KEY (MAMM) REFERENCES MOMON(MAMM)
);

-- Chèn dữ liệu mẫu cho DONVI
INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV)
VALUES ('HOA', 'Khoa Hóa học', 'Khoa', NULL);
INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV)
VALUES ('CNTT', 'Khoa CNTT', 'Khoa', NULL);
INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV)
VALUES ('PĐT', 'Phòng Đào tạo', 'Phòng', NULL);
INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV)
VALUES ('TCHC', 'Phòng Tổ chức hành chính', 'Phòng', NULL);
INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV)
VALUES ('CTSV', 'Phòng Công tác sinh viên', 'Phòng', NULL);

-- Chèn dữ liệu mẫu cho NHANVIEN
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV)
VALUES ('NV001', 'Nguyen Van A', 'Nam', TO_DATE('1980-01-01', 'YYYY-MM-DD'), 1000, 200, '0901234567', 'NVCB', 'HOA');
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV)
VALUES ('NV002', 'Tran Thi B', 'Nu', TO_DATE('1985-02-02', 'YYYY-MM-DD'), 1200, 250, '0912345678', 'TRGDV', 'HOA');
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV)
VALUES ('NV003', 'Le Van C', 'Nam', TO_DATE('1990-03-03', 'YYYY-MM-DD'), 800, 150, '0923456789', 'GV', 'CNTT');
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV)
VALUES ('NV004', 'Pham Thi D', 'Nu', TO_DATE('1975-04-04', 'YYYY-MM-DD'), 1500, 300, '0934567890', 'NV TCHC', 'TCHC');
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV)
VALUES ('NV006', 'Hoang Van F', 'Nam', TO_DATE('1982-06-06', 'YYYY-MM-DD'), 1300, 250, '0946789012', 'TRGDV', 'CNTT');
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV)
VALUES ('NV007', 'Nguyen Van E', 'Nam', TO_DATE('1988-01-02', 'YYYY-MM-DD'), 1000, 250, '0901234586', 'NV PĐT', 'PĐT');

-- Cập nhật TRGDV cho DONVI sau khi có dữ liệu NHANVIEN
UPDATE DONVI SET TRGDV = 'NV002' WHERE MADV = 'HOA';
UPDATE DONVI SET TRGDV = 'NV006' WHERE MADV = 'CNTT';

-- Chèn dữ liệu mẫu cho SINHVIEN
INSERT INTO SINHVIEN (MASV, HOTEN, PHAI, NGSINH, DCHI, DT, KHOA, TINHTRANG)
VALUES ('SV001', 'Nguyen Thi X', 'Nu', TO_DATE('2000-01-01', 'YYYY-MM-DD'), '123 Tran Hung Dao, HN', '0981234567', 'HOA', 'Đang học');
INSERT INTO SINHVIEN (MASV, HOTEN, PHAI, NGSINH, DCHI, DT, KHOA, TINHTRANG)
VALUES ('SV002', 'Tran Van Y', 'Nam', TO_DATE('2001-02-02', 'YYYY-MM-DD'), '456 Le Loi, HCM', '0982345678', 'CNTT', 'Đang học');
INSERT INTO SINHVIEN (MASV, HOTEN, PHAI, NGSINH, DCHI, DT, KHOA, TINHTRANG)
VALUES ('SV003', 'Le Thi Z', 'Nu', TO_DATE('2000-03-03', 'YYYY-MM-DD'), '789 Nguyen Trai, HN', '0983456789', 'HOA', 'Bảo lưu');
INSERT INTO SINHVIEN (MASV, HOTEN, PHAI, NGSINH, DCHI, DT, KHOA, TINHTRANG)
VALUES ('SV004', 'Pham Van W', 'Nam', TO_DATE('2001-04-04', 'YYYY-MM-DD'), '101 Hai Ba Trung, HCM', '0984567890', 'CNTT', 'Nghỉ học');
INSERT INTO SINHVIEN (MASV, HOTEN, PHAI, NGSINH, DCHI, DT, KHOA, TINHTRANG)
VALUES ('SV005', 'Hoang Thi V', 'Nu', TO_DATE('2000-05-05', 'YYYY-MM-DD'), '202 Ba Dinh, HN', '0985678901', 'HOA', 'Đang học');

-- Chèn dữ liệu mẫu cho HOCPHAN
INSERT INTO HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV)
VALUES ('HP001', 'Cơ sở dữ liệu', 3, 30, 15, 'CNTT');
INSERT INTO HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV)
VALUES ('HP002', 'Hóa học đại cương', 4, 45, 15, 'HOA');
INSERT INTO HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV)
VALUES ('HP003', 'Lập trình Java', 3, 30, 15, 'CNTT');
INSERT INTO HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV)
VALUES ('HP004', 'Hóa phân tích', 3, 30, 15, 'HOA');
INSERT INTO HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV)
VALUES ('HP005', 'An toàn bảo mật', 3, 45, 0, 'CNTT');

-- Chèn dữ liệu mẫu cho MOMON
INSERT INTO MOMON (MAMM, MAHP, MAGV, HK, NAM)
VALUES ('MM001', 'HP001', 'NV003', 1, 2024);
INSERT INTO MOMON (MAMM, MAHP, MAGV, HK, NAM)
VALUES ('MM002', 'HP002', NULL, 2, 2024);
INSERT INTO MOMON (MAMM, MAHP, MAGV, HK, NAM)
VALUES ('MM003', 'HP003', 'NV003', 3, 2024);
INSERT INTO MOMON (MAMM, MAHP, MAGV, HK, NAM)
VALUES ('MM004', 'HP004', NULL, 1, 2025);
INSERT INTO MOMON (MAMM, MAHP, MAGV, HK, NAM)
VALUES ('MM005', 'HP005', 'NV003', 2, 2025);

-- Chèn dữ liệu mẫu cho DANGKY
INSERT INTO DANGKY (MASV, MAMM, DIEMTH, DIEMQT, DIEMCK, DIEMTK)
VALUES ('SV001', 'MM001', 8.0, 7.5, 8.5, 8.0);
INSERT INTO DANGKY (MASV, MAMM, DIEMTH, DIEMQT, DIEMCK, DIEMTK)
VALUES ('SV002', 'MM001', 7.0, 6.5, 7.5, 7.0);
INSERT INTO DANGKY (MASV, MAMM, DIEMTH, DIEMQT, DIEMCK, DIEMTK)
VALUES ('SV003', 'MM002', 6.0, 6.0, 6.5, 6.2);
INSERT INTO DANGKY (MASV, MAMM, DIEMTH, DIEMQT, DIEMCK, DIEMTK)
VALUES ('SV004', 'MM003', 5.0, 5.5, 6.0, 5.5);
INSERT INTO DANGKY (MASV, MAMM, DIEMTH, DIEMQT, DIEMCK, DIEMTK)
VALUES ('SV005', 'MM002', 9.0, 8.5, 9.0, 8.8);

-- Tạo role
CREATE ROLE ROLE_NVCB;
CREATE ROLE ROLE_TRGDV;
CREATE ROLE ROLE_TCHC;

-- View cho NVCB
CREATE OR REPLACE VIEW NHANVIEN_NVCB AS
SELECT MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV
FROM NHANVIEN
WHERE MANV = USER
WITH CHECK OPTION;

-- View cho TRGDV
CREATE OR REPLACE VIEW NHANVIEN_TRGDV AS
SELECT MANV, HOTEN, PHAI, NGSINH, DT, VAITRO, MADV
FROM NHANVIEN
WHERE MADV = (SELECT MADV FROM NHANVIEN WHERE MANV = USER AND VAITRO = 'TRGDV')
ORDER BY MANV
WITH CHECK OPTION;

-- Quyền cho ROLE_NVCB
GRANT SELECT, UPDATE(DT) ON NHANVIEN_NVCB TO ROLE_NVCB;

-- Quyền cho ROLE_TRGDV
GRANT SELECT ON NHANVIEN_TRGDV TO ROLE_TRGDV;

-- Quyền cho ROLE_TCHC
GRANT SELECT, INSERT, UPDATE, DELETE ON NHANVIEN TO ROLE_TCHC;

-- Kế thừa quyền
GRANT ROLE_NVCB TO ROLE_TRGDV;
GRANT ROLE_NVCB TO ROLE_TCHC;

-- Tạo người dùng
CREATE USER NV001 IDENTIFIED BY 1;
CREATE USER NV002 IDENTIFIED BY 2;
CREATE USER NV004 IDENTIFIED BY 4;
CREATE USER NV006 IDENTIFIED BY 6;

-- Gán role
GRANT ROLE_NVCB TO NV001;
GRANT ROLE_TRGDV TO NV002, NV006;
GRANT ROLE_TCHC TO NV004;

-- Cấp quyền kết nối
GRANT CREATE SESSION TO NV001, NV002, NV004, NV006;


----------------------------------------------------------------------------------------------------------------------------
--Cau 2:
-- Tạo role
CREATE ROLE ROLE_GV;
CREATE ROLE ROLE_NVPDT;
CREATE ROLE ROLE_SINHVIEN;

-- View cho GV
CREATE OR REPLACE VIEW MOMON_GV AS
SELECT MAMM, MAHP, MAGV, HK, NAM
FROM MOMON
WHERE MAGV = USER AND MAGV IS NOT NULL
WITH CHECK OPTION;

-- View cho NV PĐT
CREATE OR REPLACE VIEW MOMON_NVPDT AS
SELECT MAMM, MAHP, MAGV, HK, NAM
FROM MOMON
WHERE HK = 1 AND NAM = 2025
WITH CHECK OPTION;

-- View cho TRGDV
CREATE OR REPLACE VIEW MOMON_TRGDV AS
SELECT m.MAMM, m.MAHP, m.MAGV, m.HK, m.NAM
FROM MOMON m
JOIN NHANVIEN n ON m.MAGV = n.MANV
WHERE n.MADV = (SELECT MADV FROM NHANVIEN WHERE MANV = USER AND VAITRO = 'TRGDV') AND m.MAGV IS NOT NULL
WITH CHECK OPTION;

-- View cho SINHVIEN
CREATE OR REPLACE VIEW MOMON_SINHVIEN AS
SELECT m.MAMM, m.MAHP, m.MAGV, m.HK, m.NAM
FROM MOMON m
JOIN HOCPHAN h ON m.MAHP = h.MAHP
JOIN SINHVIEN s ON h.MADV = s.KHOA
WHERE s.MASV = USER
WITH CHECK OPTION;

-- Quyền cho ROLE_GV
GRANT SELECT ON MOMON_GV TO ROLE_GV;

-- Quyền cho ROLE_NVPDT
GRANT SELECT, INSERT, UPDATE, DELETE ON MOMON_NVPDT TO ROLE_NVPDT;

-- Quyền cho ROLE_TRGDV
GRANT SELECT ON MOMON_TRGDV TO ROLE_TRGDV;

-- Quyền cho ROLE_SINHVIEN
GRANT SELECT ON MOMON_SINHVIEN TO ROLE_SINHVIEN;

-- Tạo người dùng
CREATE USER NV003 IDENTIFIED BY 3;
CREATE USER NV007 IDENTIFIED BY 7;
CREATE USER SV001 IDENTIFIED BY 1;
CREATE USER SV002 IDENTIFIED BY 2;
CREATE USER SV003 IDENTIFIED BY 3;
CREATE USER SV004 IDENTIFIED BY 4;
CREATE USER SV005 IDENTIFIED BY 5;

-- Gán role
GRANT ROLE_GV TO NV003;
GRANT ROLE_NVPDT TO NV007;
GRANT ROLE_SINHVIEN TO SV001, SV002, SV003, SV004, SV005;


-- Cấp quyền kết nối
GRANT CREATE SESSION TO NV003, NV007, SV001, SV002, SV003, SV004, SV005;

