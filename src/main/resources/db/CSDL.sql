-- CONNECT AS SYSUSER
CREATE PLUGGABLE DATABASE ATBMCQ_16_CSDL
ADMIN USER ATBMCQ_ADMIN IDENTIFIED BY 123
ROLES = (DBA)
FILE_NAME_CONVERT = ('PDBSEED', 'ATBMCQ_16_CSDL');

ALTER PLUGGABLE DATABASE ATBMCQ_16_CSDL OPEN READ WRITE;
ALTER SESSION SET CONTAINER = ATBMCQ_16_CSDL;

GRANT CREATE SESSION TO ATBMCQ_ADMIN CONTAINER = CURRENT;
ALTER USER ATBMCQ_ADMIN QUOTA UNLIMITED ON SYSTEM;
GRANT CREATE ROLE TO ATBMCQ_ADMIN;

GRANT SELECT ON DBA_TAB_PRIVS TO ATBMCQ_ADMIN;
GRANT SELECT ON DBA_SYS_PRIVS TO ATBMCQ_ADMIN;
GRANT SELECT ON DBA_COL_PRIVS TO ATBMCQ_ADMIN;

GRANT CREATE USER TO ATBMCQ_ADMIN;

GRANT SELECT ON DBA_ROLES TO ATBMCQ_ADMIN;
GRANT SELECT ON DBA_ROLE_PRIVS TO ATBMCQ_ADMIN;
GRANT SELECT ON DBA_TS_QUOTAS TO ATBMCQ_ADMIN;
GRANT GRANT ANY PRIVILEGE TO ATBMCQ_ADMIN;
GRANT GRANT ANY ROLE TO ATBMCQ_ADMIN;
GRANT DROP USER TO ATBMCQ_ADMIN;
GRANT ALTER USER TO ATBMCQ_ADMIN;


-- CEATE VPD MANAGER
CREATE USER VPD_MGR IDENTIFIED BY 999321;

GRANT CREATE SESSION TO VPD_MGR;
GRANT CREATE PROCEDURE TO VPD_MGR;
GRANT EXECUTE ON DBMS_RLS TO VPD_MGR;
GRANT EXECUTE ON DBMS_SESSION TO VPD_MGR;
GRANT EXECUTE ON DBMS_APPLICATION_INFO TO VPD_MGR;
GRANT UNLIMITED TABLESPACE TO VPD_MGR;


-- TẠO CONTEXT ĐỂ TRÁNH PHẢI QUERY SINHVIEN TRONG PF_SINHVIEN_SELECT
CREATE CONTEXT user_ctx USING user_ctx_pkg;
CREATE OR REPLACE PACKAGE user_ctx_pkg AS
  PROCEDURE set_user_context;
END user_ctx_pkg;
/

-- TẠO Ở VAI TRÒ SYS_USER ĐỂ ĐẢM BẢO VƯỢT QUA CÁC VPD POLICY (CHỈ CẦN BIẾT HIỆN TẠI LÀ VAI TRÒ GÌ)
CREATE OR REPLACE PACKAGE BODY user_ctx_pkg AS
  PROCEDURE set_user_context IS
    v_username VARCHAR2(30);
    v_temp    VARCHAR2(100);
  BEGIN
    v_username := SYS_CONTEXT('USERENV', 'SESSION_USER');

    -- Check if the user exists in the SINHVIEN table
    BEGIN
    SELECT MASV INTO v_temp
    FROM ATBMCQ_ADMIN.SINHVIEN
    WHERE MASV = v_username;
    EXCEPTION
        WHEN NO_DATA_FOUND
            THEN NULL; -- continue
    END;

    IF v_temp = v_username THEN
      DBMS_SESSION.SET_CONTEXT('user_ctx', 'VAI_TRO', 'SINHVIEN');
      RETURN;
    END IF;
    
    BEGIN
    SELECT VAITRO INTO v_temp 
    FROM ATBMCQ_ADMIN.NHANVIEN
    WHERE MANV = v_username;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            DBMS_SESSION.SET_CONTEXT('user_ctx', 'VAI_TRO', 'OTHER');
            RETURN; --return early
    END;
      -- Set role as 'OTHER'
      DBMS_SESSION.SET_CONTEXT('user_ctx', 'VAI_TRO', v_temp);
  END set_user_context;
END user_ctx_pkg;
/

-- CREATE A LOG ON TRIGGER
CREATE OR REPLACE TRIGGER trg_set_user_ctx
AFTER LOGON ON DATABASE
BEGIN
  user_ctx_pkg.set_user_context;
END;
/

-- CUNG CẤP QUYEN ĐỂ THỰC HIỆN VPD
GRANT SELECT ON ATBMCQ_ADMIN.NHANVIEN TO VPD_MGR;
GRANT SELECT ON ATBMCQ_ADMIN.DANGKY TO VPD_MGR;
GRANT SELECT ON ATBMCQ_ADMIN.MOMON TO VPD_MGR;



-- BAT TAT AUDIT LA QUYEN SYSDB (CAU 1)
-- BAT AUDIT    
ALTER SESSION SET CONTAINER = CDB$ROOT; -- PHAI CHUYEN VE CDB$ROOT MOI BAT DUOC
-- Bật chế độ ghi nhật ký tiêu chuẩn (STANDARD AUDIT CAU 2)
ALTER SYSTEM SET AUDIT_TRAIL = DB SCOPE = SPFILE;
SHUTDOWN IMMEDIATE;
STARTUP;

-- TAT AUDIT
ALTER SYSTEM SET AUDIT_TRAIL=NONE SCOPE=SPFILE;
SHUTDOWN IMMEDIATE;
STARTUP;


--- temp
select * from atbmcq_admin.nhanvien;
